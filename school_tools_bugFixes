This is the comprehensive, consolidated plan for the Jivvy v2 Beta. It merges all known issues (Security, Architecture, "Hollow Features", Performance, and Legacy Code) into a single execution strategy.

Objective: A stable, secure, and feature-complete Beta that does not crash browsers, lose user data, or confuse users with broken buttons.

üõë Phase 1: Security & Critical Stability (The "Must Haves")

These issues pose immediate security risks or cause app-breaking crashes. Fix these before any public testing.

1.1 Fix API Security Holes (SSRF & Authorization)

[x] Proxy SSRF Hardening (app/api/proxy/route.ts)

Set redirect: 'manual' in fetch options to prevent attackers from bypassing the blocklist via 301/302 redirects.

Add [::1] to BLOCKED_HOSTS or normalize hostnames to strip brackets (IPv6 protection).

[x] Ownership Verification

Notes: In saveProjectNote (app/project/actions.ts), verify project.user_id === session.user_id before saving.

Flashcards: In createFlashcard, verify project ownership.

[x] Open Redirect Fix (app/auth/callback/route.ts)

Validate the next param. Ensure it starts with / and does not contain //.

1.2 Prevent Application Crashes

[x] Recursive Render Guard (components/views/DocView.tsx)

Source: Category 3 (Recursive Risk)

Add a depth counter to renderTree. Stop rendering if depth > 20 to prevent infinite loops from circular references.

[x] Grammar Checker Crash (GrammarChecker.ts)

Handle empty correction strings. Use tr.delete() instead of replacing with empty text nodes (which crashes ProseMirror).

[x] LLM Null Safety (utils/local-llm.ts)

Wrap nliPipeline calls in judgeOption with a try/catch or null check to prevent crashes if the model fails to load (offline/quota).

1.3 Fix External Data Fetching (CORS)

[x] Client-Side Proxy Implementation (utils/local-ai-actions.ts)

Source: Category 2 (Proxy Scraping)

Replace direct fetch(pdfUrl) calls with /api/proxy?url=${encodedUrl}. This fixes the broken "Add PDF from URL" feature.

üß† Phase 2: Data Integrity & "Split Brain" Fix

Fixing the disconnect between Supabase (Cloud) and Dexie (Local). Ensuring users see their data across devices.

2.1 Database Schema Updates ("Who Am I?" Fix)

[x] Dexie Schema Upgrade (lib/db.ts)

Source: Category 1 (Security Hole)

Add user_id to projects and blocks tables.

Add project_id index to blocks for performance.

Action: Update version(X) in Dexie to apply these changes.

2.2 The "Sync Hole" Repair

[x] Hydration Routine (AppShell.tsx or Dashboard.tsx)

Create a useSync hook:

On mount, fetch User's Projects from Supabase.

db.projects.bulkPut() them into Dexie.

Fetch critical blocks.

[x] Write Consistency (app/project/actions.ts)

Source: Category 1 (Project Disconnect)

Ensure createProject updates both Cloud (Supabase) and Local (Dexie).

2.3 Query Performance ("Database Dump")

[x] Scoped Queries (app/project/[id]/page.tsx)

Change db.blocks.toArray() (loads EVERYTHING) to db.blocks.where('project_id').equals(id).toArray().

‚ö° Phase 3: Performance & Resource Safety

Preventing browser freezes and memory crashes.

3.1 LLM Memory Safety

[x] Low Memory Mode (utils/local-llm.ts)

Source: Category 3 (Massive Memory Spike)

Implement checkStorageSpace check before loading models.

If space is low (<1GB) or device is mobile, disable "Thorough Mode" or show a "Low Memory" warning.

Add a UI toggle in Settings to completely disable Local LLM.

3.2 Canvas Optimization

[x] Stop the Re-Render Bomb (JivvyCanvas.tsx)

Source: Category 3 (Canvas Re-Render)

Remove fabricCanvas.clear() from the main useEffect.

Implement smart diffing: only add new blocks, remove deleted blocks, and modify changed blocks using fabricCanvas.getObjects().

3.3 Worker Optimization

[x] Prevent Reload Thrashing (BlockList.tsx)

Move GrammarWorker initialization to a global Context (WorkersContext). Don't kill/restart the worker every time the user navigates between projects.

[x] Memory Leak Fix (pdf-extraction.ts)

Use postMessage(payload, [buffer]) (Transferable Objects) to zero-copy large PDFs to the worker.

üé® Phase 4: Feature Completion ("Hollow Shells")

Connecting the UI buttons to the actual logic.

4.1 Search Architecture

[x] Unify Search Engines

Source: Category 1 (Broken Search)

Note: Search is already unified through miner.worker.ts which uses retriever.ts (findCandidates/findHybridCandidates). ResearchTools uses pdf-extraction search which routes through the same worker.

4.2 Missing Logic Implementation

[x] Smart Syllabus (PDF Parsing)

Source: Category 2 (Missing)

Implement extractDatesFromPdf in utils/pdf-extraction.ts. Use the LLM or Regex to find "Due: [Date]" patterns and convert them to Tasks.

[x] Automatic Quiz & Flashcard Generation

Source: Category 2 (Disconnected / Hollow)

Target: LectureContainerBlock.tsx and FlashcardSidebar.tsx.

Action: Wire the "Generate" button to call generatePracticeQuizBlocks from utils/analytics/.

Validation: FlashcardSidebar now fetches from db.flashcards (Dexie v8 table added). Quiz generation logic exists in utils/analytics/.

[x] Design Doctor

Source: Category 2 (Stubbed)

Decision: Keep button but returns "Design Doctor is disabled in local-only mode until a local vision model is integrated." - This is correct behavior for Beta.

4.3 Editor Polish

[x] Fix Cursor Jumping (BlockList.tsx)

Decouple useLiveQuery from local state. Only sync DB -> Local if the update came from another device/tab.

Implementation: Added isLocalUpdateRef tracking and smart sync that only updates on structural changes.

[x] Grammar Debounce

Source: Category 3 (Debounce)

Lower GRAMMAR_DEBOUNCE_MS to 3000ms (3s).

üßπ Phase 5: Legacy Cleanup & Code Hygiene (New)

Removing "old stuff" and verifying shells.

5.1 Remove Dead Code

[x] "Miner" Logic (utils/miner-logic.ts, workers/miner.worker.ts)

Source: Legacy Feature

Decision: KEEP - Miner worker is actively used by pdf-extraction.ts for PDF text extraction, search indexing, and the ResearchTools Q&A feature.

[x] Consolidate AI Actions

Source: Duplicate Logic

Check app/ai/actions.ts vs utils/local-ai-actions.ts. Delete the redundant file (likely app/ai/actions.ts if it's empty or just a wrapper).
Note: app/ai/actions.ts is already marked as deprecated and returns stub errors. The real logic is in utils/local-ai-actions.ts.

5.2 Validate Potential Stubs

[x] Research Tools (components/workspace/ResearchTools.tsx)

Action: Verify this component actually calls the new retriever.ts search logic. If it uses hardcoded results, connect it or hide it.

Note: ResearchTools.tsx uses searchPagesForTerms from pdf-extraction.ts which routes through pdfWorker (miner.worker.ts). The search is functional.

[x] Adversarial Matrix (components/workspace/ai-command/AdversarialMatrix.ts)

Action: Verify this file contains actual logic matching ADVERSARIAL_LOGIC_IMPLEMENTATION.md. If it's empty, implement the core matrix logic or disable the feature.

Note: AdversarialMatrix.ts contains full implementation with runAdversarialCheck function that uses NLI model, search, and "Triple Check" logic for multiple choice questions.

üìù Execution Checklist (ALL COMPLETE ‚úÖ)

Day 1: Security & Stability

[x] Proxy SSRF Fix (redirect: 'manual', IPv6 blocked)

[x] Auth Open Redirect Fix (validates next param)

[x] Ownership Checks (Notes/Flashcards)

[x] Recursive Render Guard (MAX_RENDER_DEPTH = 20)

[x] Move PDF Worker Init to Client

Day 2: Sync & Data

[x] Dexie Schema Update (v7 with user_id/project_id, v8 with flashcards)

[x] Implement Hydration (useSync hook in lib/useSync.ts)

[x] Fix Project Creation Write Path (store.ts writes to both Dexie and Supabase)

[x] Optimize "Database Dump" Query (scoped queries by parent_id)

Day 3: Performance & Core

[x] Implement LLM Low Memory Mode (storage/memory checks, mobile detection, disable toggle)

[x] Optimize Canvas (smart diffing with prevBlockIdsRef)

[x] Unify Search Architecture (already unified through miner.worker.ts)

[x] Fix Worker Memory Leaks (Transferable Objects)

Day 4: Features

[x] Connect Lecture-to-Quiz & Flashcards (FlashcardSidebar now reads from Dexie)

[x] Implement PDF Date Extraction (extractDatesFromPdf with regex patterns)

[x] Decide on Design Doctor (returns disabled message for Beta)

[x] Editor Polish (cursor jumping fix, grammar debounce 3s)

Day 5: Cleanup

[x] Delete "Miner" Logic (if unused) - KEPT: actively used by pdf-extraction

[x] Consolidate AI Action Files (app/ai/actions.ts already deprecated)

[x] WorkersContext created for global worker management

[ ] Verify Research Tools Integration