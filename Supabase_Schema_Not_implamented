-- Enable UUID extension for auto-generating IDs
create extension if not exists "uuid-ossp";

-- 1. Create Enum for Subscription Tiers
create type subscription_tier as enum ('free', 'pro');

-- 2. Profiles Table (Extends Supabase Auth)
create table public.profiles (
  id uuid references auth.users(id) on delete cascade not null primary key,
  email text not null,
  tier subscription_tier default 'free'::subscription_tier,
  created_at timestamptz default now()
);

-- 3. Projects Table
create table public.projects (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,
  pdf_url text not null,
  extracted_constraints jsonb default '{}'::jsonb, -- Stores the AI extracted spec sheet
  created_at timestamptz default now(),

  -- Rule: Unique constraint to enforce 1 PDF per project per user
  constraint unique_pdf_per_user unique (user_id, pdf_url)
);

-- 4. Notes Table (Chunked Storage)
create table public.notes (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.projects(id) on delete cascade not null,
  content_chunk text, -- or jsonb, depending on Tiptap configuration
  order_index int default 0,
  created_at timestamptz default now()
);

-- 5. Canvas Snapshots Table (Rolling Backups)
create table public.canvas_snapshots (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.projects(id) on delete cascade not null,
  storage_path text not null, -- Path to the JSON blob in Storage Bucket
  preview_path text, -- Path to the PNG preview in Storage Bucket
  created_at timestamptz default now()
);

-- Index for fast retrieval of latest snapshot: "Query strictly via project_id order by created_at desc"
create index idx_canvas_snapshots_lookup on public.canvas_snapshots(project_id, created_at desc);

-- 6. Flashcards Table
create table public.flashcards (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.projects(id) on delete cascade not null,
  front text not null,
  back text not null,
  source_node_id text, -- Links card back to specific Tiptap node for "Green Highlight"
  created_at timestamptz default now()
);

-- -------------------------------------------------------------------------
-- ROW LEVEL SECURITY (RLS)
-- Security Rules: Users can ONLY see/edit their own data.
-- -------------------------------------------------------------------------

alter table profiles enable row level security;
alter table projects enable row level security;
alter table notes enable row level security;
alter table canvas_snapshots enable row level security;
alter table flashcards enable row level security;

-- Profiles Policy
create policy "Users can view own profile" on profiles
  for select using (auth.uid() = id);

-- Projects Policies
create policy "Users can CRUD own projects" on projects
  for all using (auth.uid() = user_id);

-- Notes Policies (via Project ownership)
create policy "Users can CRUD own notes" on notes
  for all using (
    exists (select 1 from projects where id = notes.project_id and user_id = auth.uid())
  );

-- Canvas Snapshots Policies (via Project ownership)
create policy "Users can CRUD own snapshots" on canvas_snapshots
  for all using (
    exists (select 1 from projects where id = canvas_snapshots.project_id and user_id = auth.uid())
  );

-- Flashcards Policies (via Project ownership)
create policy "Users can CRUD own flashcards" on flashcards
  for all using (
    exists (select 1 from projects where id = flashcards.project_id and user_id = auth.uid())
  );

-- -------------------------------------------------------------------------
-- AUTOMATION: Auto-create profile on signup
-- -------------------------------------------------------------------------
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, email)
  values (new.id, new.email);
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();